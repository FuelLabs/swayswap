name: "CI"

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, edited, closed]

env:
  COMPOSE_VERSION: 2.6.0

jobs:
  # cancel-previous-run:
  #   name: Cancel previous actions
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v3
  #     - uses: n1hility/cancel-previous-runs@v2
  #       with:
  #         token: ${{ secrets.GITHUB_TOKEN }}

  # validate-pr:
  #   name: Validate PR title
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Pull request title check
  #       uses: amannn/action-semantic-pull-request@v4
  #       env:
  #         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-and-test:
    name: Build and test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: ./.github/workflows/setup-forc.yaml
        id: setup-forc

      - name: Test Contracts
        if: ${{ steps.setup-forc.steps.changed-contracts.outputs.any_changed == 'true' }}
        run: |
          ./scripts/test-contracts.sh

      - uses: ./.github/workflows/setup-node.yaml

      # Check lint as early as possible to avoid
      # Long fail CI and fail on this step
      - name: Lint
        run: |
          pnpm lint

      - name: Setup Docker
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Make github action to use the latest version of
      # docker compose without it docker compose down
      # has issues with memory nil pointer
      # https://github.com/docker/compose/pull/9354
      - name: Install Compose
        uses: ndeloof/install-compose-action@v0.0.1
        with:
          version: v${{ env.COMPOSE_VERSION }}

      - name: Docker info
        run: |
          docker info

      - name: Setup scripts
        run: |
          pnpm scripts:setup

      - name: Integration & Unit Test
        run: |
          pnpm ci:test-coverage
